SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO




CREATE VIEW [Datakwaliteit].[vw_InExploitatieDatumInaccuraat]
AS
SELECT -- extra kolommen die handig kunnen zijn op rapportage op deze view
    oge.Nr_ AS Eenheidnr,
    oge.straatnaam + '  ' + oge.huisnr_ + '  ' + oge.Toevoegsel AS [Adres eenheid],
    CAST(GETDATE() AS DATE) AS [Gegenereerd op],

    -- Standaardkolommen tbv insert in RealisatieDetails tabel
    1 AS Waarde,
    CAST(GETDATE() AS DATE) AS Laaddatum,
    'Eenheidsoort: ' + CASE [typ].[Soort]
                           WHEN 0 THEN
                               'Woning'
                           WHEN 1 THEN
                               'Bedrijfsruimte'
                       END + '; ' + 'Corpodata type: ' + [typ].[Analysis Group Code] + '; ' + 'Technisch type: '
    + [typ].Omschrijving + '; ' + 'Eeheidstatus: ' + CASE [oge].[Status]
                                                         WHEN 0 THEN
                                                             'Leegstand'
                                                         WHEN 1 THEN
                                                             'Uit beheer'
                                                         WHEN 2 THEN
                                                             'Renovatie'
                                                         WHEN 3 THEN
                                                             'Verhuurd'
                                                         WHEN 4 THEN
                                                             'Administratief'
                                                         WHEN 5 THEN
                                                             'Verkocht'
                                                         WHEN 6 THEN
                                                             'In ontwikkeling'
                                                     END + '; ' + 'Bouwjaar: ' + FORMAT([oge].[Construction Year], 'G') AS Omschrijving,
    NULL AS Teller,
    NULL AS Noemer,
    NULL AS Klantnr,
    CONVERT(DATE, NULL) AS datEinde,
    CONVERT(DATE, NULL) AS datIngang,
    NULL AS Hyperlink,
    NULL AS Gebruiker,
    NULL AS Relatienr,
    '2 In exploitatie datum ligt voor het bouwjaar van de eenheid' AS Bevinding
FROM [empire_data].[dbo].[Staedion$OGE] oge
    INNER JOIN empire_data.dbo.Staedion$Type typ
        ON [oge].[Type] = [typ].[Code]
WHERE [oge].[Status] IN (   2, -- Renovatie
                            3, -- Verhuurd
                            4
                        ) -- Administratief
      AND [typ].[Soort] IN (   0, -- Woning
                               1
                           ) -- Bedrijfsruimte
      AND [oge].[Begin exploitatie] <> '1753-01-01'
      AND [oge].[Construction Year] <> 0
      AND YEAR([oge].[Begin exploitatie]) < [oge].[Construction Year]
	  AND [oge].[Construction Year] >= 2012
UNION
SELECT -- extra kolommen die handig kunnen zijn op rapportage op deze view
    oge.Nr_ AS Eenheidnr,
    oge.straatnaam + '  ' + oge.huisnr_ + '  ' + oge.Toevoegsel AS [Adres eenheid],
    CAST(GETDATE() AS DATE) AS [Gegenereerd op],

    -- Standaardkolommen tbv insert in RealisatieDetails tabel
    1 AS Waarde,
    CAST(GETDATE() AS DATE) AS Laaddatum,
    'Eenheidsoort: ' + CASE [typ].[Soort]
                           WHEN 0 THEN
                               'Woning'
                           WHEN 1 THEN
                               'Bedrijfsruimte'
                       END + '; ' + 'Corpodata type: ' + [typ].[Analysis Group Code] + '; ' + 'Technisch type: '
    + [typ].Omschrijving + '; ' + 'Eeheidstatus: ' + CASE [oge].[Status]
                                                         WHEN 0 THEN
                                                             'Leegstand'
                                                         WHEN 1 THEN
                                                             'Uit beheer'
                                                         WHEN 2 THEN
                                                             'Renovatie'
                                                         WHEN 3 THEN
                                                             'Verhuurd'
                                                         WHEN 4 THEN
                                                             'Administratief'
                                                         WHEN 5 THEN
                                                             'Verkocht'
                                                         WHEN 6 THEN
                                                             'In ontwikkeling'
                                                     END + '; ' + 'Bouwjaar: ' + FORMAT([oge].[Construction Year], 'G') AS Omschrijving,
    NULL AS Teller,
    NULL AS Noemer,
    NULL AS Klantnr,
    CONVERT(DATE, NULL) AS datEinde,
    CONVERT(DATE, NULL) AS datIngang,
    NULL AS Hyperlink,
    NULL AS Gebruiker,
    NULL AS Relatienr,
    '3 Datum in exploitatie ligt niet voor datum uit exploitatie terwijl de eenheid uit exploitatie is.' AS Bevinding
FROM [empire_data].[dbo].[Staedion$OGE] oge
    LEFT OUTER JOIN empire_data.dbo.Staedion$Type typ
        ON [oge].[Type] = [typ].[Code]
WHERE [oge].[Status] IN (   2, -- Renovatie
                            3, -- Verhuurd
                            4
                        ) -- Administratief
      AND [typ].[Soort] IN (   0, -- Woning
                               1
                           ) -- Bedrijfsruimte
      AND [oge].[Begin exploitatie] <> '1753-01-01'
      AND [oge].[Einde exploitatie] <> '1753-01-01'
      AND [oge].[Einde exploitatie] < [oge].[Begin exploitatie];

GO
