SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO




CREATE view [Datakwaliteit].[OntbrekendeDatumInExploitatie] as
/* ##############################################################################################################################
--------------------------------------------------------------------------------------------------------------------------
METADATA
--------------------------------------------------------------------------------------------------------------------------
WIJZIGINGEN
JvdW 20200624 Aangemaakt obv input Marieke
--------------------------------------------------------------------------------------------------------------------------
TEST
--------------------------------------------------------------------------------------------------------------------------
METADATA
--------------------------------------------------------------------------------------------------------------------------
EXEC [empire_staedion_data].[dbo].[dsp_info_object_en_velden] 'staedion_dm', 'Datakwaliteit', 'OntbrekendeDatumInExploitatie'

--------------------------------------------------------------------------------------------------------------------------
AANVULLENDE INFO
--------------------------------------------------------------------------------------------------------------------------
-- Marieke: combinatie die niet voor mag komen: 
> Leegstand of verhuurd
> datum in exploitatie / reden niet is ingevuld

select top 5 * from staedion_dm.[Datakwaliteit].[OntbrekendeDatumInExploitatie] 
select top 10 * from staedion_dm.datakwaliteit.Realisatiedetails


################################################################################################################################## */    
					
WITH cte_contractregel
AS (
       SELECT eenheidnr_
              ,[Datum eerste contractregel] = min(Ingangsdatum)
       FROM empire_data.dbo.staedion$contract
       WHERE [Dummy Contract] = 0
       GROUP BY eenheidnr_
       )
-- omschrijving: datum in exploitatie ? = eerste ingangsdatum contractregel of geen contractregel gevonden ?
SELECT ELS.eenheidnr
       ,Adres = ELS.straat + ' ' + coalesce(convert(NVARCHAR(10), nullif(ELS.huisnummer, '0')) + ' ', '') + ELS.toevoegsel
       ,Opmerking = 'Status eenheidskaart: '
												+ coalesce(ELS.status_eenheidskaart,'?')
												+ ' ; Datum in exploitatie: leeg'
												+ ' ; Reden in exploitatie: '
												+  coalesce(nullif(ELS.[Reden in exploitatie],''),'leeg')
												+ ' ; ingangsdatum eerste contractregel = ' 
												+ coalesce(convert(NVARCHAR(20), CTE.[Datum eerste contractregel], 105), 'Niet bekend')
       ,ELS.datum_gegenereerd
FROM empire_staedion_data.dbo.els AS ELS
LEFT OUTER JOIN cte_contractregel AS CTE
       ON ELS.eenheidnr = CTE.eenheidnr_
WHERE status_eenheidskaart IN (
              'Leegstand'
              ,'Verhuurd'
              )
       AND datum_in_exploitatie IS NULL
       AND datum_gegenereerd = (
              SELECT max(datum_gegenereerd)
              FROM empire_staedion_data.dbo.els
             -- WHERE datum_gegenereerd < '20200701'
              )





GO
