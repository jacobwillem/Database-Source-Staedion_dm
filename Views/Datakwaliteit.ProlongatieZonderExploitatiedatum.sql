SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO









CREATE view [Datakwaliteit].[ProlongatieZonderExploitatiedatum]
as
with cte_prolongatieposten as 
(select Eenheidnr_, Boekingsdatum, Stuknummer, volgnr = Row_number() over (partition by Eenheidnr_ order by Boekingsdatum asc)
from empire_data.dbo.[Staedion$Prolongatiepost]
--where Eenheidnr_ = 'OGEH-0061525'
)
SELECT Eenheidnr = BRON.Nr_, 
       CLUS.Clusternr, 
       CLUS.Clusternaam, 
       Assetmanager = coalesce(CONT.Assetmanager, 'Onbekend'), 
			 TT.Omschrijving,
       [Huurder] = coalesce(HRD.aanhef, 'Leegstand'),
			 BRON.[Begin exploitatie] ,
			 BRON.[Einde exploitatie] ,
			 [Huidige brutohuur] = HPR.brutohuur_inclbtw,
			 [Datum eerste nota] = CTE.Boekingsdatum

			 -- select top 10 TT.*
FROM empire_data.dbo.staedion$oge AS BRON
left outer join empire_Data.dbo.staedion$type as TT
on TT.[Code] = BRON.[Type]
and TT.Soort <> 2
join cte_prolongatieposten as CTE 
on CTE.Eenheidnr_ = BRON.Nr_
and CTE.volgnr = 1
     OUTER APPLY empire_staedion_data.[dbo].[ITVFnContactbeheerInclNaam](BRON.Nr_) AS CONT
     OUTER APPLY empire_staedion_data.[dbo].ITVfnCLusterBouwblok(BRON.Nr_) AS CLUS
     OUTER APPLY empire_staedion_data.[dbo].[ITVfnHuurprijs](BRON.Nr_, getdate()) AS HPR
     OUTER APPLY empire_staedion_data.[dbo].ITVfnContractaanhef(HPR.huurdernr) AS HRD
WHERE BRON.[Common Area] = 0
and HPR.kalehuur = 0
and BRON.[Begin exploitatie] = '17530101'
--and BRON.Nr_ = 'OGEH-0061525'



GO
