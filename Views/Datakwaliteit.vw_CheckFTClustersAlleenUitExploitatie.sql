SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO


CREATE VIEW [Datakwaliteit].[vw_CheckFTClustersAlleenUitExploitatie]
AS

/* #################################################################################################################################
BETREFT		Als FB-medewerker wil ik weten welke clusters alleen maar eenheden hebben die uit exploitatie zijn zodat ik die anders kan labelen \ archiveren
------------------------------------------------------------------------------------------------------------------------------------
WIJZIGING	  
20201104 JvdW Op verzoek van Marieke Peeters (mail)
------------------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------
TEST
------------------------------------------------------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------
METADATA
-------------------------------------------------------------------------------------------------
EXEC [empire_staedion_data].[dbo].[dsp_info_object_en_velden] staedion_dm, 'Datakwaliteit', 'vw_CheckFTClustersAlleenUitExploitatie'

select	kolom = [name]
			,domein = system_type_name
			,Bron = source_database  + '.' + source_Schema + '.' + source_column   
from sys.dm_exec_describe_first_result_set('select * from staedion_dm.Datakwaliteit.vw_CheckFTClustersAlleenUitExploitatie',null,1)


-- extended property toevoegen op object-niveau
USE staedion_dm;  
GO  
EXEC sys.sp_addextendedproperty   
@name = N'MS_Description',   
@value = N'Simpele check op eenheden in bedrijf Staedion - hoeveel per FT-cluster - hoeveel met datum uit of in exploitatie zodat je de clusters eruit kunt halen die alleen maar eenheden met einde exploitatiedatum hebben',   
@level0type = N'SCHEMA', @level0name = 'Datakwaliteit',  
@level1type = N'VIEW',  @level1name = 'vw_CheckFTClustersAlleenUitExploitatie'
;  
EXEC sys.sp_addextendedproperty   
@name = N'Auteur',   
@value = N'JvdW',   
@level0type = N'SCHEMA', @level0name = 'Datakwaliteit',  
@level1type = N'VIEW',  @level1name = 'vw_CheckFTClustersAlleenUitExploitatie'
;  
EXEC sys.sp_addextendedproperty   
@name = N'VoorbeeldAanroep',   
@value = N'select * from [Datakwaliteit].[vw_CheckFTClustersAlleenUitExploitatie] where Opmerking = ''Alles uit exploitatie''',   
@level0type = N'SCHEMA', @level0name = 'Datakwaliteit',  
@level1type = N'VIEW',  @level1name = 'vw_CheckFTClustersAlleenUitExploitatie'
;  
EXEC sys.sp_addextendedproperty   
@name = N'CNSAfhankelijk',   
@value = N'Nee',   
@level0type = N'SCHEMA', @level0name = 'Datakwaliteit',  
@level1type = N'VIEW',  @level1name = 'vw_CheckFTClustersAlleenUitExploitatie'


################################################################################################################################# */




SELECT Clusternr = KRUIS.Clusternr_
       ,[Aantal eenheden] = count(*)
       ,[Aantal uit exploitatie] = sum(CASE 
                     WHEN nullif(OGE.[Einde exploitatie], '17530101') IS not NULL
                            THEN 1
                     ELSE 0
                     END)
       ,[Aantal zonder begin exploitatie] = sum(CASE 
                     WHEN nullif(OGE.[Begin exploitatie], '17530101') IS NULL
                            THEN 1
                     ELSE 0
                     END)
       ,[Opmerking] = iif(count(*) = sum(CASE 
                            WHEN nullif(OGE.[Einde exploitatie], '17530101') IS not NULL
                                   THEN 1
                            ELSE 0
                            END), 'Alles uit exploitatie', '')
-- SELECT OGE.Nr_, OGE.[Begin exploitatie],OGE.[Einde exploitatie] ,KRUIS.Clusternr_
FROM empire_data.dbo.staedion$oge AS OGE
LEFT OUTER JOIN empire_Data.dbo.[Staedion$cluster_oge] AS KRUIS
       ON KRUIS.Eenheidnr_ = OGE.Nr_
              AND KRUIS.Clustersoort = 'FTCLUSTER'
WHERE OGE.[Common Area] = 0
--and KRUIS.Clusternr_ = 'FT-1004'
group by KRUIS.Clusternr_




GO
EXEC sp_addextendedproperty N'Auteur', N'JvdW', 'SCHEMA', N'Datakwaliteit', 'VIEW', N'vw_CheckFTClustersAlleenUitExploitatie', NULL, NULL
GO
EXEC sp_addextendedproperty N'CNSAfhankelijk', N'Nee', 'SCHEMA', N'Datakwaliteit', 'VIEW', N'vw_CheckFTClustersAlleenUitExploitatie', NULL, NULL
GO
EXEC sp_addextendedproperty N'MS_Description', N'Simpele check op eenheden in bedrijf Staedion - hoeveel per FT-cluster - hoeveel met datum uit of in exploitatie zodat je de clusters eruit kunt halen die alleen maar eenheden met einde exploitatiedatum hebben', 'SCHEMA', N'Datakwaliteit', 'VIEW', N'vw_CheckFTClustersAlleenUitExploitatie', NULL, NULL
GO
EXEC sp_addextendedproperty N'VoorbeeldAanroep', N'select * from [Datakwaliteit].[vw_CheckFTClustersAlleenUitExploitatie] where Opmerking = ''Alles uit exploitatie''', 'SCHEMA', N'Datakwaliteit', 'VIEW', N'vw_CheckFTClustersAlleenUitExploitatie', NULL, NULL
GO
